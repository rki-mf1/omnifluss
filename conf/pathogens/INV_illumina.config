/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

params {
    read_qc                   = 'fastp,fastqc'
    taxonomic_classifier      = 'kraken2'
    reference_selection       = 'dynamic'
    aligner                   = 'bwa'
    variant_caller            = 'lofreq'
    consensus_caller          = 'bcftools'

    skip_taxonomic_filtering  = false
    skip_primer_clipping      = true
    skip_read_qc              = false

    taxonomic_classifier      = 'kraken2'
    kraken2_taxid_filter_list = '11308 11320 11520'

    cns_mincov                = 50

}

process {

    withName: FASTP {
        ext.args = '--low_complexity_filter --overrepresentation_analysis --qualified_quality_phred 20 --length_required 50'
    }

    withName: BWA_MEM {
        ext.args = '-L 10 -Y -R "@RG\\tID:SAMPLE_NAME\\tPU:SAMPLE_NAME\\tSM:SAMPLE_NAME\\tPL:ILLUMINA\\tLB:000"'
    }

    withName: 'PICARD_MARKDUPLICATES' {
        ext.args = '-REMOVE_DUPLICATES true'
    }

    withName: KRAKEN2_KRAKEN2 {
        ext.args = '--use-names'
    }

    withName: BCFTOOLS_FILTER {
        ext.args = '-e "TYPE=\'indel\' && INFO/AF < 0.9" --output-type z'
        ext.prefix = { "${meta.id}.filtered" }
    }

    withName: BCFTOOLS_CONSENSUS {
        ext.args = '-H I -i "INFO/AF >= 0.1"'
    }

    withName: 'LOFREQ_INDELQUAL' {
        ext.args    = '--dindel'
        ext.prefix  = { "${meta.id}.indelqual" }
    }

    withName: 'BCFTOOLS_INDEX' {
        ext.args    = '--tbi'
    }

    withName: 'BCFTOOLS_NORM' {
        ext.args    = '-Oz -c s  --write-index=tbi'
        ext.prefix  = { "${meta.id}.normed" }
    }

    withName: 'MINIMAP2_SEGMENT_DB' {
        ext.prefix  = {
            "${meta.id}.minimap"
        }
        ext.args    = {
            '-x sr -p 0.99 -B18 -O24,40 -E7,3 -N200'
        }
    }

    withName: 'SEQKIT_GREP' {
        ext.args    = { '--quiet' }
        ext.prefix  = { "${meta.id}.top5References" }
    }

    withName: 'MINIMAP2_SEGMENT_TOP5' {
        ext.prefix  = {
            "${meta.id}.minimap.top5"
        }
        ext.args    = {
            '-I10g -ax sr -Y --seed 42 --sam-hit-only'
        }
    }

    withName: 'SAMTOOLS_COVERAGE' {
        ext.prefix  = { "${meta.id}.coverage" }
    }

    withName: 'SAMTOOLS_DEPTH' {
        ext.prefix  = {
            "${meta1.id}.depth"
        }
        ext.args    = {
            '-a'
        }
    }
}
